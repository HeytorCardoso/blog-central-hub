<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Artigos</title>
    <link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background: #ddd; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { max-width: 991px; width: 100%; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .toolbar { padding: 16px; background: #eee; border-bottom: 1px solid #ddd; }
        .toolbar .head { display: flex; grid-gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
        .toolbar .head > input { max-width: 150px; padding: 6px 10px; border-radius: 6px; border: 2px solid #ddd; outline: none; }
        .toolbar .head select, .toolbar .head .color-btn { background: #fff; border: 2px solid #ddd; border-radius: 6px; outline: none; cursor: pointer; padding: 5px; display: flex; align-items: center; grid-gap: 6px; }
        .toolbar .head .color-btn input { border: none; width: 26px; height: 26px; cursor: pointer; background: none; }
        .toolbar .btn-toolbar { display: flex; flex-wrap: wrap; align-items: center; grid-gap: 10px; }
        .toolbar .btn-toolbar button { background: #fff; border: 2px solid #ddd; border-radius: 6px; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: 0.3s; }
        .toolbar .btn-toolbar button:hover { background: #f3f3f3; border-color: #bbb; }
        #content { height: 400px; font-size: 16px; }
        .ql-toolbar.ql-snow { display: none; }
        .ql-container.ql-snow { border: none !important; }
        #show-code[data-active="true"] { background: #333; color: #fff; }
        .remove-bg { font-size: 12px; padding: 2px 5px; background: #fb4747; color: white; border-radius: 4px; cursor: pointer; border: none; }
        #content .ql-editor img {
        max-width: 100%;
        /* Garante que o atributo style do HTML seja soberano */
        height: auto !important; 
        }
        #content img { max-width: 100%; height: auto; cursor: pointer; display: inline-block; transition: border 0.2s; }
        #content img:hover { outline: 3px solid #007bff; }
    </style>
</head>
<body>
    <form id="articleForm" action="" method="POST">
        <div class="container">
            <div class="toolbar">
                <div class="head">
                    <input type="text" id="filename" name="titleForm" value="{{article.title}}" placeholder="Título">
                    <input type="text" id="sub_filename" name="sub_titleForm" value="{{article.sub_title}}" placeholder="Subtítulo">
                    <select onchange="fileHandle(this.value); this.selectedIndex=0">
                        <option value="" selected hidden disabled>File</option>
                        <option value="new">New file</option>
                        <option value="txt">Save as txt</option>
                        <option value="pdf">Save as pdf</option>
                    </select>
                    <select onchange="quill.format('header', this.value)">
                        <option value="" selected hidden disabled>Format</option>
                        <option value="1">Heading 1</option>
                        <option value="2">Heading 2</option>
                        <option value="3">Heading 3</option>
                        <option value="4">Heading 4</option>
                        <option value="5">Heading 5</option>
                        <option value="6">Heading 6</option>
                        <option value="0">Normal</option>
                    </select>
                    <select onchange="quill.format('size', this.value)">
                        <option value="" selected hidden disabled>Font size</option>
                        <option value="small">Small</option>
                        <option value="false">Regular</option>
                        <option value="large">Large</option>
                        <option value="huge">Extra Large</option>
                    </select>
                    <div class="color-btn">
                        <span>Color</span>
                        <input type="color" oninput="quill.format('color', this.value)">
                    </div>
                    <div class="color-btn">
                        <span>BG</span>
                        <input type="color" oninput="quill.format('background', this.value)">
                        <button class="remove-bg" type="button" onclick="quill.format('background', false)">X</button>
                    </div>
                </div>
                <div class="btn-toolbar">
                    <button type="button" onclick="quill.history.undo()"><i class='bx bx-undo'></i></button>
                    <button type="button" onclick="quill.history.redo()"><i class='bx bx-redo'></i></button>
                    <button type="button" onclick="toggleFormat('bold')"><i class='bx bx-bold'></i></button>
                    <button type="button" onclick="toggleFormat('underline')"><i class='bx bx-underline'></i></button>
                    <button type="button" onclick="toggleFormat('italic')"><i class='bx bx-italic'></i></button>
                    <button type="button" onclick="toggleFormat('strike')"><i class='bx bx-strikethrough'></i></button>
                    <button type="button" onclick="quill.format('align', '')"><i class='bx bx-align-left'></i></button>
                    <button type="button" onclick="quill.format('align', 'center')"><i class='bx bx-align-middle'></i></button>
                    <button type="button" onclick="quill.format('align', 'right')"><i class='bx bx-align-right'></i></button>
                    <button type="button" onclick="quill.format('align', 'justify')"><i class='bx bx-align-justify' ></i></button>
                    <button type="button" onclick="quill.format('list', 'ordered')"><i class='bx bx-list-ol'></i></button>
                    <button type="button" onclick="quill.format('list', 'bullet')"><i class='bx bx-list-ul'></i></button>
                    <button type="button" onclick="addLink()"><i class='bx bx-link'></i></button>
                    <button type="button" onclick="quill.format('link', false)"><i class='bx bx-unlink'></i></button>
                    <button type="button" onclick="insertImage()"><i class='bx bx-image' ></i></button>
                    <button type="button" id="show-code" data-active="false">&lt;/&gt;</button>
                    
                    <button type="submit" style="background-color: lightgreen;"><i class='bx bx-save'></i></button>
                    <button type="button" onclick="window.location.href='/article/delete/{{article.id}}'" style="background-color: lightcoral;"><i class='bx bx-trash'></i></button>
                </div>
            </div>
            <input type="hidden" name="contentForm" id="contentForm">
            <div id="content">
                {% if article.content %}
                    {{ article.content | safe }}
                {% else %}
                    <p>Comece a escrever aqui...</p>
                {% endif %}
            </div>
        </div>
    </form>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>

        // Registra o suporte para estilos inline (como width) nas imagens
var ImageFormat = Quill.import('formats/image');

class CustomImage extends ImageFormat {
    static formats(domNode) {
        let formats = super.formats(domNode);
        if (domNode.hasAttribute('style')) {
            formats['style'] = domNode.getAttribute('style');
        }
        return formats;
    }
    format(name, value) {
        if (name === 'style') {
            this.domNode.setAttribute('style', value);
        } else {
            super.format(name, value);
        }
    }
}

Quill.register(CustomImage, true);

        const quill = new Quill('#content', {
            theme: 'snow',
            modules: { toolbar: false }
        });

        // 4. Lógica para interceptar o submit e passar o HTML do Quill para o input oculto
        const form = document.getElementById('articleForm');
        form.onsubmit = function() {
            const contentInput = document.getElementById('contentForm');
            contentInput.value = quill.root.innerHTML; // Pega o HTML do editor
            return true; // Continua o envio
        };

        function toggleFormat(type) {
            const current = quill.getFormat()[type];
            quill.format(type, !current);
        }

        function addLink() {
            const url = prompt('Insira a URL:');
            if (url) quill.format('link', url);
        }

        function insertImage() {
            const url = prompt('Insira a URL da imagem:');
            if (url) {
                const range = quill.getSelection();
                quill.insertEmbed(range ? range.index : 0, 'image', url);
            }
        }

        document.getElementById('content').addEventListener('click', function(e) {
            if (e.target.tagName === 'IMG') {
                const newWidth = prompt("Digite a largura da imagem (ex: 300px ou 50%):", e.target.style.width || e.target.width || "100%");
                if (newWidth !== null) {
                    e.target.style.width = newWidth;
                }
            }
        });

        const btnShowCode = document.getElementById('show-code');
        let isCodeMode = false;

        btnShowCode.addEventListener('click', function() {
            isCodeMode = !isCodeMode;
            this.dataset.active = isCodeMode;
            if (isCodeMode) {
                const html = quill.root.innerHTML;
                quill.root.innerText = html;
                quill.disable();
            } else {
                const text = quill.root.innerText;
                quill.root.innerHTML = text;
                quill.enable();
            }
        });

        function fileHandle(value) {
            const filename = document.getElementById('filename').value || 'untitled';
            if (value === 'new') {
                quill.setContents([]);
            } else if (value === 'txt') {
                const blob = new Blob([quill.getText()], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename + ".txt";
                a.click();
            } else if (value === 'pdf') {
                html2pdf().from(quill.root).save(filename);
            }
        }
    </script>
</body>
</html>